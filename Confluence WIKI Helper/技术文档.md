# Confluence WIKI Helper 技术文档

## 项目概述

**项目名称**: Confluence WIKI Helper  
**包名**: `com.jambus.wikihelper`  
**版本**: 1.0.0  
**最低Android版本**: API 26 (Android 8.0)  

企业知识库智能问答应用，基于Dify API实现智能对话系统。

## 系统架构

### 技术栈
- **架构模式**: MVVM + Clean Architecture
- **语言**: Kotlin 1.9.10
- **UI框架**: Jetpack Compose + Material Design 3
- **状态管理**: StateFlow + ViewModel
- **依赖注入**: Hilt
- **数据存储**: Room Database
- **网络通信**: Retrofit2 + OkHttp3
- **安全存储**: Android Keystore + EncryptedSharedPreferences

### 项目结构
```
com.jambus.wikihelper/
├── MainActivity.kt                    // 主Activity
├── WikiHelperApplication.kt          // Application类
├── data/
│   ├── remote/
│   │   ├── api/
│   │   │   └── DifyApiService.kt     // API接口定义
│   │   ├── model/
│   │   │   └── DifyModels.kt         // 数据模型
│   │   └── NetworkModule.kt          // 网络配置
│   ├── local/
│   │   ├── entity/
│   │   │   └── ChatMessageEntity.kt  // 数据库实体
│   │   ├── dao/
│   │   │   └── ChatDao.kt            // Room DAO接口
│   │   └── database/
│   │       └── WikiHelperDatabase.kt // Room数据库
│   ├── repository/
│   │   ├── ChatRepository.kt         // 聊天数据仓库
│   │   └── DifyRepository.kt         // Dify API仓库
│   └── security/
│       └── SecurityManager.kt        // 安全配置
├── di/
│   └── AppModule.kt                  // 依赖注入配置
├── ui/
│   ├── components/
│   │   ├── ChatMessage.kt            // 消息组件
│   │   └── InputBar.kt               // 输入栏组件
│   ├── screens/
│   │   └── ChatScreen.kt             // 主屏幕
│   ├── theme/
│   │   ├── Color.kt                  // 颜色主题
│   │   ├── Theme.kt                  // 主题配置
│   │   └── Type.kt                   // 字体样式
│   └── viewmodel/
│       └── ChatViewModel.kt          // 聊天ViewModel
└── utils/
    └── NetworkResult.kt              // 网络结果封装
```

## 核心功能模块

### 1. 网络层 (Remote Layer)

#### API接口定义
```kotlin
interface DifyApiService {
    @POST("chat-messages")
    suspend fun sendChatMessage(@Header authToken: String, @Body request: DifyChatRequest): Response<DifyChatResponse>
    
    @POST("completion-messages")
    suspend fun sendCompletionMessage(@Header authToken: String, @Body request: DifyCompletionRequest): Response<DifyChatResponse>
}
```

#### 数据模型
```kotlin
@Serializable
data class DifyChatRequest(
    val query: String,
    val user: String,
    val response_mode: String = "streaming",
    val conversation_id: String? = null
)
```

### 2. 数据存储层 (Local Layer)

#### Room数据库实体
```kotlin
@Entity(tableName = "chat_messages")
data class ChatMessageEntity(
    val message: String,
    val isUser: Boolean,
    val timestamp: Date = Date(),
    val conversationId: String? = null,
    val references: String? = null
)
```

### 3. 安全存储
```kotlin
class SecurityManager {
    fun storeApiKey(apiKey: String) // 使用Android Keystore加密存储
    fun getApiKey(): String? // 安全获取API密钥
}
```

### 4. 用户界面

#### 主要组件
- **ChatScreen**: 主聊天界面
- **ChatMessage**: 消息展示组件
- **InputBar**: 底部输入栏

#### 主题配置
```kotlin
val PrimaryBlue = Color(0xFF007DBC)
val PrimaryYellow = Color(0xFFFFEA00)
```

## API配置

### Dify集成参数
- **Base URL**: `https://api.dify.ai/v1/`
- **认证**: Bearer Token (API Key)
- **端点**:
  - 聊天消息: `/chat-messages`
  - 完成消息: `/completion-messages`

### 响应模式
- **流式响应**: `response_mode = "streaming"`
- **普通响应**: `response_mode = "blocking"`

## 构建配置

### Gradle配置
```kotlin
android {
    compileSdk = 34
    defaultConfig {
        minSdk = 26
        applicationId = "com.jambus.wikihelper"
    }
}
```

### 国内镜像配置
- **阿里云镜像**: 多个仓库配置
- **腾讯云镜像**: 备用镜像源
- **Gradle版本**: 8.2.1

### 依赖版本
- **Android Gradle Plugin**: 8.1.4
- **Kotlin**: 1.9.10
- **Compose**: 1.5.3
- **Hilt**: 2.48
- **Retrofit**: 2.9.0
- **Room**: 2.6.1

## 开发环境配置

### 1. 系统要求
- JDK 17+
- Android Studio Hedgehog (2023.1.1) 或更高版本
- Android SDK 34

### 2. 本地开发设置
```bash
# 克隆项目
git clone [project-url]
cd Confluence\ WIKI\ Helper

# 构建项目
./gradlew build

# 安装到设备
./gradlew installDebug
```

### 3. 环境变量
```properties
# gradle.properties
android.useAndroidX=true
android.nonTransitiveRClass=true
```

## 部署指南

### 1. 开发环境
```bash
# 清理并构建
./gradlew clean build

# 运行测试
./gradlew test

# 生成APK
./gradlew assembleRelease
```

### 2. 配置API密钥
首次运行时会弹出API密钥配置对话框，或手动在设置中配置。

### 3. 打包发布
```bash
# 生成签名APK
./gradlew assembleRelease

# 生成AAB
./gradlew bundleRelease
```

## 故障排除

### 常见问题
1. **构建失败**: 检查Java版本和Gradle版本兼容性
2. **依赖下载**: 确保网络连接，国内用户已配置镜像
3. **API密钥**: 确保Dify API密钥有效且权限正确

### 调试技巧
- 使用`./gradlew build --stacktrace`查看详细错误
- 清除缓存：`./gradlew clean`
- 刷新依赖：`./gradlew build --refresh-dependencies`

## 性能优化

### 1. 网络优化
- 使用OkHttp连接池
- 配置超时时间
- 启用压缩

### 2. 内存优化
- 使用ViewModel管理状态
- 避免内存泄漏
- 合理使用Room数据库

### 3. UI优化
- 使用LazyColumn优化长列表
- 合理使用Compose状态
- 启用R8代码压缩

## 测试策略

### 1. 单元测试
- Repository层测试
- ViewModel逻辑测试
- 网络层测试

### 2. 集成测试
- UI组件测试
- 数据库测试
- API集成测试

### 3. 端到端测试
- 完整用户流程测试
- 性能测试
- 兼容性测试